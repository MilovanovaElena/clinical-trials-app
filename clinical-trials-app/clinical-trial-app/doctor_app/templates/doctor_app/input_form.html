{% extends 'doctor_app/base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        {% if show_result %}
        <div class="alert {% if is_normal %}alert-success{% else %}alert-warning{% endif %} mt-3">
            <h4>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—è:</h4>
            <div class="mb-3">
                <strong>–î–∞–Ω–Ω—ã–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞:</strong><br>
                ‚Ä¢ ID –ø–∞—Ü–∏–µ–Ω—Ç–∞: <strong>{{ patient_id }}</strong><br>
                ‚Ä¢ –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ: <strong>{{ study_name }}</strong><br>
                ‚Ä¢ –ü—Ä–µ–ø–∞—Ä–∞—Ç: <strong>{{ drug_taken }}</strong><br>
                ‚Ä¢ –û—Ü–µ–Ω–∫–∞ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—è: <strong>{{ condition_score }} –±–∞–ª–ª–æ–≤</strong>
            </div>

            <div class="mb-3">
                <strong>–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö:</strong><br>
                {{ analysis_result }}
            </div>

            {% if analysis_details %}
            <hr>
            <div class="mt-2">
                <small class="text-muted">
                    <strong>–î–µ—Ç–∞–ª–∏ —Ä–∞—Å—á–µ—Ç–∞:</strong><br>
                    ‚Ä¢ –°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç—É: <strong>{{ analysis_details.average_score }} –±–∞–ª–ª–æ–≤</strong><br>
                    ‚Ä¢ –î–∏–∞–ø–∞–∑–æ–Ω –Ω–æ—Ä–º—ã (¬±10%): <strong>{{ analysis_details.lower_bound }} - {{ analysis_details.upper_bound }} –±–∞–ª–ª–æ–≤</strong><br>
                    ‚Ä¢ –í–∞—à–∞ –æ—Ü–µ–Ω–∫–∞: <strong>{{ analysis_details.current_score }} –±–∞–ª–ª–æ–≤</strong><br>
                    ‚Ä¢ –°—Ç–∞—Ç—É—Å: <strong>{% if analysis_details.is_in_range %}–≤ –Ω–æ—Ä–º–µ{% else %}–≤–Ω–µ –Ω–æ—Ä–º—ã{% endif %}</strong>
                </small>
            </div>
            {% endif %}
        </div>
        {% endif %}

        {% if error %}
        <div class="alert alert-danger mt-3">
            <h4>‚ùå –û—à–∏–±–∫–∞:</h4>
            <p>{{ error }}</p>
        </div>
        {% endif %}

        {% if success_message %}
        <div class="alert alert-success mt-3">
            <h4>‚úÖ –£—Å–ø–µ—Ö!</h4>
            <p>{{ success_message }}</p>
        </div>
        {% endif %}

        <div class="card">
            <div class="card-header">
                <h4 class="mb-0 text-center">–°–∏—Å—Ç–µ–º–∞ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è</h4>
            </div>
            <div class="card-body">
                <form method="post" id="dataForm">
                    {% csrf_token %}

                    {% for field in form %}
                    <div class="mb-3">
                        <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                        {{ field }}
                        {% if field.errors %}
                        <div class="alert alert-danger mt-1">
                            {% for error in field.errors %}
                            <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}

                    <button type="submit" class="btn btn-primary w-100">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const studySelect = document.getElementById('id_study');
    const drugSelect = document.getElementById('id_drug');

    // –î–∞–Ω–Ω—ã–µ –æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞—Ö –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ Django
    const studiesData = {{ studies_data|safe }};

    function updateDrugOptions() {
        const studyId = studySelect.value;
        drugSelect.innerHTML = '';

        if (studyId && studiesData[studyId]) {
            const study = studiesData[studyId];
            const drugName = study.drug_name;

            // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = '--- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç ---';
            drugSelect.appendChild(emptyOption);

            // –î–æ–±–∞–≤–ª—è–µ–º –ü–ª–∞—Ü–µ–±–æ
            const placeboOption = document.createElement('option');
            placeboOption.value = '–ü–ª–∞—Ü–µ–±–æ';
            placeboOption.textContent = '–ü–ª–∞—Ü–µ–±–æ';
            drugSelect.appendChild(placeboOption);

            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—Å—Ç–æ—è—â–∏–π –ø—Ä–µ–ø–∞—Ä–∞—Ç –∏–∑ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
            const drugOption = document.createElement('option');
            drugOption.value = drugName;
            drugOption.textContent = drugName;
            drugSelect.appendChild(drugOption);
        } else {
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = '--- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ ---';
            drugSelect.appendChild(emptyOption);
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
    studySelect.addEventListener('change', updateDrugOptions);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    updateDrugOptions();
});
</script>
{% endblock %}